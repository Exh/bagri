<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:hz="http://www.hazelcast.com/schema/spring"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd
		http://www.hazelcast.com/schema/spring http://www.hazelcast.com/schema/spring/hazelcast-spring-3.2.xsd">

	<context:property-placeholder ignore-unresolvable="true" location="classpath:/xdm-cache-server.properties" />
	<context:annotation-config />
 
	<!--bean id="mbeanServer" class="java.lang.management.ManagementFactory" factory-method="getPlatformMBeanServer"/>
 	<context:mbean-export server="mbeanServer" default-domain="com.bagri.xdm"/-->
 
	<hz:client id="hzInstance">
		<hz:group name="${xdm.schema.name}" password="${xdm.schema.password}"/>
	
		<hz:network smart-routing="true">
			<hz:member>${xdm.schema.members}</hz:member>
		</hz:network>
		
		<!--hz:security>
			<hz:credentials>com.hazelcast.security.UsernamePasswordCredentials</hz:credentials>
		</hz:security-->
	
		<hz:serialization>
			<hz:portable-factories>
				<hz:portable-factory factory-id="1" class-name="com.bagri.xdm.access.hazelcast.pof.XDMPortableFactory"/>
			</hz:portable-factories>
			<hz:serializers>
				<!--hz:global-serializer class-name="com.hazelcast.nio.serialization.PortableSerializer"/-->
				<hz:serializer type-class="com.bagri.xdm.domain.XDMElement" class-name="com.bagri.xdm.access.hazelcast.pof.XDMElementSerializer"/>
				<hz:serializer type-class="com.bagri.xdm.domain.XDMPath" class-name="com.bagri.xdm.access.hazelcast.pof.XDMPathSerializer"/>
				<hz:serializer type-class="com.bagri.xdm.domain.XDMDocument" class-name="com.bagri.xdm.access.hazelcast.pof.XDMDocumentSerializer"/>
				<hz:serializer type-class="com.bagri.xdm.domain.XDMDocumentType" class-name="com.bagri.xdm.access.hazelcast.pof.XDMDocumentTypeSerializer"/>
				<hz:serializer type-class="com.bagri.xdm.domain.XDMNamespace" class-name="com.bagri.xdm.access.hazelcast.pof.XDMNamespaceSerializer"/>
			</hz:serializers>
		</hz:serialization>

		<!--hz:proxy-factories>
			<hz:proxy-factory service=""/>
		</hz:proxy-factories-->
		
		<hz:near-cache name="dict-path" in-memory-format="OBJECT" />
		<hz:near-cache name="dict-namespace" in-memory-format="OBJECT" />
		<hz:near-cache name="dict-document-type" in-memory-format="OBJECT" />
		
	</hz:client>
	
	<hz:map id="xdm-document" name="xdm-document" instance-ref="hzInstance" />
	<hz:map id="xdm-element" name="xdm-element" instance-ref="hzInstance" />
	<hz:map id="dict-document-type" name="dict-document-type" instance-ref="hzInstance" />
	<hz:map id="dict-path" name="dict-path" instance-ref="hzInstance" />
	<hz:map id="dict-namespace" name="dict-namespace" instance-ref="hzInstance" />

	<hz:idGenerator id="xdm.document" name="xdm.document" instance-ref="hzInstance"/>
	<hz:idGenerator id="xdm.element" name="xdm.element" instance-ref="hzInstance"/>
	<hz:idGenerator id="xdm.path" name="xdm.path" instance-ref="hzInstance"/>
	<hz:idGenerator id="xdm.namespace" name="xdm.namespace" instance-ref="hzInstance"/>
	<hz:idGenerator id="xdm.doctype" name="xdm.doctype" instance-ref="hzInstance"/>
	
	<hz:executorService id="xdm-exec-pool" name="xdm-exec-pool" instance-ref="hzInstance"/>
	
	<bean id="xdmFactory" class="com.bagri.xdm.access.hazelcast.impl.HazelcastXDMFactory" />

	<bean id="xdmDictionary" class="com.bagri.xdm.access.hazelcast.impl.HazelcastSchemaDictionary">
		<constructor-arg ref="hzInstance"/>
	</bean>

	<bean id="xdmManager" class="com.bagri.xdm.access.hazelcast.impl.HazelcastDocumentManager">
		<constructor-arg ref="hzInstance"/>
		<property name="xdmFactory" ref="xdmFactory"/>
		<property name="schemaDictionary" ref="xdmDictionary"/>
	</bean>

    <bean id="xqDataSource" class="com.bagri.xqj.BagriXQDataSource">
        <property name="properties">
            <props>
                <prop key="address">${xdm.schema.members}</prop>
                <prop key="schema">${xdm.schema.name}</prop>
            </props>
        </property>
    </bean>

    <bean id="xqConnection" factory-bean="xqDataSource" factory-method="getConnection">
    	<property name="processor" ref="xqProcessor" />
    </bean>

    <bean id="xqProcessor" class="com.bagri.xquery.saxon.BagriXQProcessor">
    	<property name="xdmManager" ref="xdmManager" />
    	<property name="XQDataFactory" ref="xqConnection" />
    </bean>

	<bean id="queryManager" class="com.bagri.xdm.cache.hazelcast.management.QueryManagement">
		<constructor-arg value="${xdm.schema.name}" />
		<property name="documentManager" ref="xdmManager"/>
		<property name="schemaDictionary" ref="xdmDictionary"/>
		<property name="XQConnection" ref="xqConnection"/>
	</bean>

	<bean id="docManager" class="com.bagri.xdm.cache.hazelcast.management.DocumentManagement">
		<constructor-arg value="${xdm.schema.name}" />
		<property name="documentManager" ref="xdmManager"/>
		<property name="schemaDictionary" ref="xdmDictionary"/>
	</bean>

</beans>